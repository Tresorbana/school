generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum DayOfWeek {
  Monday
  Tuesday
  Wednesday
  Thursday
  Friday
}

enum RoleType {
  admin
  teacher
  inactive
}

enum TransactionType {
  INCOME
  EXPENSE
}

model User {
  user_id    String    @id @default(uuid()) @db.Uuid
  first_name String    @db.VarChar(255)
  last_name  String    @db.VarChar(255)
  email      String    @unique @db.VarChar(255)
  password   String    @db.VarChar(255)
  is_active  Boolean   @default(true)
  created_at DateTime  @default(now()) @db.Timestamptz(6)
  updated_at DateTime  @default(now()) @db.Timestamptz(6)

  roles                        UserRole[]
  class_course_assignments      ClassCourseAssignment[]
  class_teachers               ClassTeacher[]
  timetable_roster             TimetableRoster[]
  late_approved_records         Record[]                 @relation("LateApprovedBy")
  audit_logs                   AuditLog[]
  received_fees                FeePayment[]             @relation("FeeRecipient")
  financial_records            FinancialRecord[]        @relation("FinancialCreator")
  attendance_permission_requests AttendancePermissionRequest[]
  marks                        Mark[]
  received_notifications       Notification[]           @relation("ReceivedNotifications")
  created_notifications        Notification[]           @relation("CreatedNotifications")
}

model Role {
  role_id    String   @id @default(uuid()) @db.Uuid
  role_name  RoleType
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)

  users UserRole[]
}

model UserRole {
  user_id     String   @db.Uuid
  role_id     String   @db.Uuid
  assigned_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  role Role @relation(fields: [role_id], references: [role_id], onDelete: Cascade)

  @@id([user_id, role_id])
}

model Intake {
  intake_id          String   @id @default(uuid()) @db.Uuid
  intake_name        String   @unique @db.VarChar(255)
  start_year         Int
  end_year           Int
  current_year_level Int      @default(1)
  is_active          Boolean  @default(true)
  created_at         DateTime @default(now()) @db.Timestamptz(6)
  updated_at         DateTime @default(now()) @db.Timestamptz(6)

  students Student[]
}

model Class {
  class_id   String   @id @default(uuid()) @db.Uuid
  class_name String   @db.VarChar(255)
  year_level Int
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)

  students                     Student[]
  class_course_assignments      ClassCourseAssignment[]
  class_teachers               ClassTeacher[]
  timetables                   Timetable[]
  timetable_roster             TimetableRoster[]
  attendance_permission_requests AttendancePermissionRequest[]
}

model Student {
  student_id String   @id @default(uuid()) @db.Uuid
  first_name String   @db.VarChar(255)
  last_name  String   @db.VarChar(255)
  email      String   @unique @db.VarChar(255)
  gender     String?  @db.VarChar(10)
  intake_id  String?  @db.Uuid
  class_id   String?  @db.Uuid
  is_active  Boolean  @default(true)
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @default(now()) @db.Timestamptz(6)

  intake           Intake?          @relation(fields: [intake_id], references: [intake_id], onDelete: SetNull)
  class            Class?           @relation(fields: [class_id], references: [class_id], onDelete: SetNull)
  attendance       Attendance[]
  fee_payments     FeePayment[]
  marks            Mark[]
}

model Course {
  course_id   String   @id @default(uuid()) @db.Uuid
  course_name String   @db.VarChar(255)
  year_level  Int
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @db.Timestamptz(6)

  class_course_assignments    ClassCourseAssignment[]
  timetable_roster           TimetableRoster[]
  marks                      Mark[]
}

model ClassCourseAssignment {
  assignment_id String   @id @default(uuid()) @db.Uuid
  class_id      String   @db.Uuid
  course_id     String   @db.Uuid
  teacher_id    String?  @db.Uuid
  academic_year Int      @default(dbgenerated("extract(year from now())"))
  is_active     Boolean  @default(true)
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  updated_at    DateTime @default(now()) @db.Timestamptz(6)

  class   Class   @relation(fields: [class_id], references: [class_id], onDelete: Cascade)
  course  Course  @relation(fields: [course_id], references: [course_id], onDelete: Cascade)
  teacher User?   @relation(fields: [teacher_id], references: [user_id], onDelete: SetNull)

  @@unique([class_id, course_id, academic_year])
}

model ClassTeacher {
  class_teacher_id String   @id @default(uuid()) @db.Uuid
  user_id          String   @db.Uuid
  class_id         String   @db.Uuid
  academic_year    Int
  is_active        Boolean  @default(true)
  created_at       DateTime @default(now()) @db.Timestamptz(6)
  updated_at       DateTime @default(now()) @db.Timestamptz(6)

  user  User  @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  class Class @relation(fields: [class_id], references: [class_id], onDelete: Cascade)

  @@unique([class_id, academic_year])
}

model Timetable {
  timetable_id  String   @id @default(uuid()) @db.Uuid
  year          Int
  term          Int
  class_id      String?  @db.Uuid
  academic_year String?  @db.VarChar(9)
  is_active     Boolean  @default(false)
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  updated_at    DateTime @default(now()) @db.Timestamptz(6)

  class            Class?            @relation(fields: [class_id], references: [class_id], onDelete: Cascade)
  timetable_roster TimetableRoster[]
}

model TimetableRoster {
  roster_id    String    @id @default(uuid()) @db.Uuid
  timetable_id String    @db.Uuid
  course_id    String?   @db.Uuid
  user_id      String?   @db.Uuid
  class_id     String?   @db.Uuid
  day_of_week  DayOfWeek
  period       Int
  classroom    String?   @db.VarChar(50)
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  updated_at   DateTime  @default(now()) @db.Timestamptz(6)

  timetable                   Timetable                   @relation(fields: [timetable_id], references: [timetable_id], onDelete: Cascade)
  course                      Course?                     @relation(fields: [course_id], references: [course_id], onDelete: SetNull)
  user                        User?                       @relation(fields: [user_id], references: [user_id], onDelete: SetNull)
  class                       Class?                      @relation(fields: [class_id], references: [class_id], onDelete: SetNull)
  records                     Record[]
  attendance_permission_requests AttendancePermissionRequest[]
}

model Record {
  record_id           String   @id @default(uuid()) @db.Uuid
  timetable_roster_id String   @db.Uuid
  recording_status    String   @default("on_time") @db.VarChar(20)
  late_approved_by    String?  @db.Uuid
  late_approved_at    DateTime? @db.Timestamptz(6)
  created_at          DateTime @default(now()) @db.Timestamptz(6)
  updated_at          DateTime @default(now()) @db.Timestamptz(6)

  timetable_roster TimetableRoster @relation(fields: [timetable_roster_id], references: [roster_id], onDelete: Cascade)
  late_approver    User?          @relation("LateApprovedBy", fields: [late_approved_by], references: [user_id], onDelete: SetNull)
  attendance       Attendance[]
}

model Attendance {
  attendance_id String   @id @default(uuid()) @db.Uuid
  student_id    String   @db.Uuid
  record_id     String   @db.Uuid
  is_present    Boolean  @default(false)
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  updated_at    DateTime @default(now()) @db.Timestamptz(6)

  student Student @relation(fields: [student_id], references: [student_id], onDelete: Cascade)
  record  Record  @relation(fields: [record_id], references: [record_id], onDelete: Cascade)
}

model AttendancePermissionRequest {
  request_id      String   @id @default(uuid()) @db.Uuid
  teacher_id      String   @db.Uuid
  timetable_roster_id String @db.Uuid
  class_id        String   @db.Uuid
  period_date     DateTime @db.Timestamptz(6)
  period_number   Int
  reason_category String   @db.VarChar(50)
  reason_notes    String?
  status          String   @default("pending") @db.VarChar(20)
  approved_by     String?  @db.Uuid
  approved_at     DateTime? @db.Timestamptz(6)
  admin_comments  String?
  created_at      DateTime @default(now()) @db.Timestamptz(6)
  updated_at      DateTime @default(now()) @db.Timestamptz(6)
  
  teacher         User     @relation(fields: [teacher_id], references: [user_id], onDelete: Cascade)
  timetable_roster TimetableRoster @relation(fields: [timetable_roster_id], references: [roster_id], onDelete: Cascade)
  class           Class    @relation(fields: [class_id], references: [class_id], onDelete: Cascade)
}

model FeePayment {
  payment_id     String   @id @default(uuid()) @db.Uuid
  student_id     String   @db.Uuid
  amount         Decimal  @db.Decimal(12, 2)
  academic_year  Int
  term           Int
  category       String   @db.VarChar(100)
  payment_date   DateTime @default(now()) @db.Timestamptz(6)
  received_by    String?  @db.Uuid
  description    String?

  student     Student @relation(fields: [student_id], references: [student_id], onDelete: Cascade)
  recipient   User?   @relation("FeeRecipient", fields: [received_by], references: [user_id], onDelete: SetNull)
}

model FinancialRecord {
  record_id     String          @id @default(uuid()) @db.Uuid
  type          TransactionType
  amount        Decimal         @db.Decimal(12, 2)
  category      String          @db.VarChar(100)
  description   String?
  created_at    DateTime        @default(now()) @db.Timestamptz(6)
  created_by    String?         @db.Uuid

  creator       User?           @relation("FinancialCreator", fields: [created_by], references: [user_id], onDelete: SetNull)
}

model DeliberationRule {
  rule_id     String   @id @default(uuid()) @db.Uuid
  min_score   Float
  max_score   Float
  grade       String   @db.VarChar(10)
  comment     String?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now()) @db.Timestamptz(6)
}

model Mark {
  mark_id       String   @id @default(uuid()) @db.Uuid
  student_id    String   @db.Uuid
  course_id     String   @db.Uuid
  teacher_id    String   @db.Uuid
  score         Float
  academic_year Int
  term          Int
  comments      String?
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  updated_at    DateTime @default(now()) @db.Timestamptz(6)

  student Student @relation(fields: [student_id], references: [student_id], onDelete: Cascade)
  course  Course  @relation(fields: [course_id], references: [course_id], onDelete: Cascade)
  teacher User    @relation(fields: [teacher_id], references: [user_id], onDelete: Cascade)

  @@unique([student_id, course_id, academic_year, term])
}

model AuditLog {
  log_id      String   @id @default(uuid()) @db.Uuid
  user_id     String?  @db.Uuid
  table_name  String   @db.VarChar(100)
  action_type String   @db.VarChar(50)
  record_id   String?  @db.VarChar(255)
  details     Json?
  description String?
  created_at  DateTime @default(now()) @db.Timestamptz(6)

  user User? @relation(fields: [user_id], references: [user_id], onDelete: SetNull)
}

model Notification {
  notification_id   String   @id @default(uuid()) @db.Uuid
  target_user_id     String   @db.Uuid
  creator_id        String?  @db.Uuid
  message           String   @db.Text
  notification_type String   @default("general") @db.VarChar(50)
  priority          Int      @default(2) // 1=high, 2=normal, 3=low
  is_read           Boolean  @default(false)
  created_at        DateTime @default(now()) @db.Timestamptz(6)
  updated_at        DateTime @default(now()) @db.Timestamptz(6)

  target_user User  @relation("ReceivedNotifications", fields: [target_user_id], references: [user_id], onDelete: Cascade)
  creator     User? @relation("CreatedNotifications", fields: [creator_id], references: [user_id], onDelete: SetNull)
}
